--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://ko-fi.com/glytch3r
Discord: Glytch3r#1337 / glytch3r



----------------------------------------------------------------------------------------------------------------------------
--]]

--require "TankZed_Util"
TankZedModII = TankZedModII or {}

local Commands = {};
Commands.TankZedII = {};

TankZedModII.skin1 = 'TankZedModII.Dreadnought1'
TankZedModII.skin2 = 'TankZedModII.Dreadnought2'

TankZedModII.skinList = {
	['TankZedModII.Dreadnought1'] = true,
	['TankZedModII.Dreadnought2'] = true
}
------------------------    pl*           ----------
function TankZedModII.wearTankZedII(pl, int)
	pl = pl or getPlayer()
	TankZedModII.clearTankZedIISkin(pl)
	int = int or ZombRand(1,3)
	local item = InventoryItemFactory.CreateItem('TankZedModII.Dreadnought'..tostring(int))
	local inv = pl:getInventory()
	if not inv then return end
	local equip = inv:AddItem(item);
	if not equip then return end
	local loc = equip:getBodyLocation()
	if not loc then return end
	pl:setWornItem(loc, equip);
	triggerEvent("OnClothingUpdated", pl)
end

-----------------------     working*       ---------------------------
function TankZedModII.isTankSkin(fType)
	return fType == tostring(TankZedModII.skin1) or fType == tostring(TankZedModII.skin2)
end
function TankZedModII.clearTankZedIISkin(pl)
	local inv = pl:getInventory()
	for i = inv:getItems():size(), 1, -1 do
		local item = inv:getItems():get(i-1)
		local fType = item:getFullType()
		if item and TankZedModII.isTankSkin(fType) then
			--pl:removeWornItem(item)
			inv:DoRemoveItem(item)
		end
	end
	TankZedModII.removeTag(pl)
	--	inv:removeAllItems()
	pl:clearWornItems();
	pl:resetModelNextFrame();
end

-----------------------               ------------------------------
-- local pl = getPlayer() ;TankZedModII.isWearingTankZedII(pl)
function TankZedModII.isWearingTankZedII(pl)
	pl = pl or getPlayer()
	if not pl then return end
	local inv = pl:getInventory()
	for i=0, pl:getWornItems():size()-1 do
		local equip = pl:getWornItems():getItemByIndex(i)
		if equip then
			local fType = equip:getFullType()
			if fType then
				return TankZedModII.skinList[tostring(fType)] or false
			end
		end
	end
	return false
end
--getPlayer():getInventory():contains(TankZedModII.skin) and getPlayer():getWornItems():contains(TankZedModII.skin)

-----------------------            ---------------------------

function TankZedModII.AdminTankZedII(pl)
	if TankZedModII.isWearingTankZedII(pl) then
		if pl:getVariableBoolean('isWearingTankZedII') == false then
			pl:setVariable('isWearingTankZedII', 'true')
			if not pl:isHideWeaponModel() then
				pl:setHideWeaponModel(true)
				--TankZedModII.setTag(pl)
			end
			if isClient() then
				sendClientCommand('TankZedII', 'isWearingTankZedII', {isWearingTankZedII = true})
			end
		end
	else
		if pl:getVariableBoolean('isWearingTankZedII') == true then
			pl:setVariable('isWearingTankZedII', 'false');
			if pl:isHideWeaponModel() then
				pl:setHideWeaponModel(false)
				--TankZedModII.removeTag(pl)
			end
			if isClient() then
				sendClientCommand('TankZedII', 'isWearingTankZedII', {isWearingTankZedII = false})
			end
		end
	end

end

--Events.OnPlayerUpdate.Remove(TankZedModII.AdminTankZedII)
--Events.OnPlayerUpdate.Add(TankZedModII.AdminTankZedII)



TankZedModII.plTaunt = {
	"TankZedII_SFX1",
	"TankZedII_Growl",
	"TankZedII_Spawn",
	"TankZedII_Distant",
	"TankZedII_Agre",
}

TankZedModII.plHurt = {
	"TankZedII_Pain1",
	"TankZedII_Pain2",
	"TankZedII_Weak",
}
TankZedModII.plDie = {
	"TankZedII_Death",
	"TankZedII_Distant",
	"TankZedII_Weak",
}

TankZedModII.plAttack = {
	"TankZedII_Growl",
	"TankZedII_Attack2",
	"TankZedII_Attack1",
	"TankZedII_Charge",
}

function TankZedModII.playPlSfx(pl, tab, attract)

	if pl:isGhostMode() or pl:isInvincible() then return end
	if not TankZedModII.isWearingTankZedII(pl) then return end
	local sq = pl:getSquare()
	if sq then
		getSoundManager():PlayWorldSound(tostring(tab[ZombRand(1,#tab+1)]), pl:getSquare(), 0, 5, 5, false);
		if attract then
			addSound(pl, pl:getX(), pl:getY(), pl:getZ(), 5, 1);
		end
	end
end

function TankZedModII.plDeath(pl)
	TankZedModII.playPlSfx(pl, TankZedModII.plDie, false)
end
Events.OnPlayerDeath.Remove(TankZedModII.plDeath)
Events.OnPlayerDeath.Add(TankZedModII.plDeath)

function TankZedModII.keypress(key)
	local pl = getPlayer()
	if not TankZedModII.isWearingTankZedII(pl) then return end
    if key == getCore():getKey("Shout") then
		pl:playEmote('TankZedII_Low_Taunt')
		TankZedModII.playPlSfx(pl, TankZedModII.plTaunt, true)
		return key
    end
end
Events.OnKeyPressed.Remove(TankZedModII.keypress)
Events.OnKeyPressed.Add(TankZedModII.keypress)

function TankZedModII.OnWeaponSwing(pl, wpn)
	if pl ~= getPlayer() then return end
	if not TankZedModII.isWearingTankZedII(pl) then return end
	if tostring(WeaponType.getWeaponType(pl)) == 'barehand' or (wpn and wpn:getCategories():contains("Unarmed")) then
		if TankZedModII.doRoll(15) then
			TankZedModII.playPlSfx(pl, TankZedModII.plAttack, false)
		end
	end
end
Events.OnWeaponSwing.Remove(TankZedModII.OnWeaponSwing)
Events.OnWeaponSwing.Add(TankZedModII.OnWeaponSwing)


function TankZedModII.plBash(adm, targ, wpn, HP)
	if targ == getPlayer() then
		TankZedModII.playPlSfx(targ, TankZedModII.plHurt, false)
	end
	if instanceof(adm, 'IsoZombie') then return end
	if instanceof(targ, 'IsoZombie') then return end
	if not TankZedModII.isWearingTankZedII(adm) then return end


	if isClient() then
		sendClientCommand('TankZedII', 'Bashed', {targID = targ:getOnlineID();})
	end
	TankZedModII.doBash(targ)
end
Events.OnWeaponHitCharacter.Remove(TankZedModII.plBash)
Events.OnWeaponHitCharacter.Add(TankZedModII.plBash)


local function init(plNum,pl)
	if pl == nil then
		pl = getPlayer()
	end
	if pl then
		if pl:getAlpha() ~= 1 then
			pl:setAlpha(1)
			sendPlayerExtraInfo(pl)
		end
	end
end
Events.OnCreatePlayer.Remove(init)
Events.OnCreatePlayer.Add(init)


--	TankZedModII.doBash(pl)

