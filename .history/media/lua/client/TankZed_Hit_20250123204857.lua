--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://ko-fi.com/glytch3r
Discord: Glytch3r#1337 / glytch3r



----------------------------------------------------------------------------------------------------------------------------
--]]

--require "TankZed_Util"
TankZedModII = TankZedModII or {}

-----------------------               ---------------------------



function TankZedModII.hitZed(zed, pl, part, wpn)
	if TankZedModII.isWearingTankZedII(pl) then
		return
	end

	if TankZedModII.isTankZed(zed) then
		zed:setAvoidDamage(true)

		if isDebugEnabled() then
			if zed:getPlayerAttackPosition() ~= nil then
			zed:addLineChatElement(tostring(zed:getPlayerAttackPosition()))
			end
		end

		if TankZedModII.isUnarmed(pl, wpn) then
			zed:setVariable("hitreaction", "HitArmor")
			return
		end


		if zed:getPlayerAttackPosition() == 'BEHIND' then
			local num = TankZedModII.getTankZedNum(zed)
			local page = TankZedModII.getSandboxPage(num)

			local varHP = page.HP or 12
			local mult = page.Multiplier or 1
			local healthDmg = mult / varHP

			zed:setHealth(zed:getHealth() - healthDmg)
			local hp = zed:getHealth()

			if isDebugEnabled() then
				zed:SayDebug(tostring(hp))
				print(tostring(hp))
			end

			--zed:setVariable("hitreaction", "HitArmor")

			if pl == getPlayer() then
				zed:getEmitter():stopAll()
				TankZedModII.playPainSfx(zed)
			end


			zed:setVariable("hitreaction", "TankZed_HitReact")
		else
			zed:setVariable("hitreaction", "HitArmor")
		end
		local hp = zed:getHealth()
		if (hp and hp <= 0) or zed:getVariableBoolean('zDeath') then
			zed:setAvoidDamage(false)
			zed:setImmortalTutorialZombie(false)
			zed:changeState(ZombieOnGroundState.instance())
			zed:setAttackedBy(pl)
			zed:becomeCorpse()
		end
	end
end


-- Remove and add the event handler to ensure it's properly registered
Events.OnHitZombie.Remove(TankZedModII.hitZed)
Events.OnHitZombie.Add(TankZedModII.hitZed)

function TankZedModII.DropRoll(pl)
	local DropHandItemChance = SandboxVars.TankZedModII.DropHandItemChance
	if DropHandItemChance == 0 then return false end
	return TankZedModII.doRoll(DropHandItemChance)
end

function TankZedModII.doDrop(pl)
	if not TankZedModII.DropRoll(pl) then return end
	local pr = pl:getPrimaryHandItem()
	if not pr then return end
	if tostring(WeaponType.getWeaponType(pl)) == 'barehand' or  pr:getCategories():contains("Unarmed") then return end
	if pr ~= nil then
		local sr = pl:getSecondaryHandItem()
		if sr ~= nil then
			if (wpn:isRequiresEquippedBothHands() or wpn:isTwoHandWeapon()) and sr == pr then
				pl:setPrimaryHandItem(nil)
				pl:setSecondaryHandItem(nil)
				luautils.equipItems(pl, nil, nil)
			else
				pl:setPrimaryHandItem(nil)
				luautils.equipItems(pl, nil, sr)
			end
		else
			pl:setPrimaryHandItem(nil)
			luautils.equipItems(pl, nil, nil)
		end
		pl:getInventory():Remove(wpn);
		pl:getCurrentSquare():AddWorldInventoryItem(wpn, 0,0,0);
		ISInventoryPage.dirtyUI();
	end
end


function TankZedModII.FracRoll(pl)
	local InjuryChance = SandboxVars.TankZedModII.InjuryChance
	if InjuryChance == 0 then return false end
	return TankZedModII.doRoll(InjuryChance)
end
function TankZedModII.doFrac(pl)
	if not TankZedModII.FracRoll(pl) then return end
	local part = TankZedModII.getPart(pl)
	local fracTime = part:getFractureTime()
	if fracTime > 0 then
		local max = 101-fracTime
		local roll = fracTime + ZombRand(1, max)
		part:setFractureTime(roll)
	else
		part:setFractureTime(ZombRand(1, 101))
	end
end

function TankZedModII.doPain(pl)
	local part = TankZedModII.getPart(pl)
	local addPain = part:getAdditionalPain()
	if addPain > 0 then
		local max = 101-addPain
		local roll = addPain + ZombRand(1, max)
		part:setAdditionalPain(roll)
	else
		part:setAdditionalPain(ZombRand(1, 101))
	end
end


function TankZedModII.getPart(pl)
	local bdDmg = pl:getBodyDamage()
	local parts = {
		[1]=bdDmg:getBodyPart(BodyPartType.Torso_Upper),
		[2]=bdDmg:getBodyPart(BodyPartType.ForeArm_L),
		[3]=bdDmg:getBodyPart(BodyPartType.ForeArm_R),
		[4]=bdDmg:getBodyPart(BodyPartType.UpperArm_L),
		[5]=bdDmg:getBodyPart(BodyPartType.UpperArm_R),
		[6]=bdDmg:getBodyPart(BodyPartType.Neck),
		[7]=bdDmg:getBodyPart(BodyPartType.Back),
		[8]=bdDmg:getBodyPart(BodyPartType.Head),
	}
	return parts[ZombRand(1,9)]
end

function TankZedModII.BashRoll(pl)
	local BashChance = SandboxVars.TankZedModII.BashChance
	if BashChance == 0 then return false end
	return TankZedModII.doRoll(BashChance)
end
function TankZedModII.doAddDmg(pl)
	local minDmg = SandboxVars.TankZedModII.MinDmg
	local maxDmg = SandboxVars.TankZedModII.MaxDmg
	local part = TankZedModII.getPart(pl)
	part:AddDamage(ZombRand(minDmg, maxDmg+1))
end

function TankZedModII.doBash(pl)
	pl:setBumpType("Bash")
	pl:setVariable("BumpFall", true)
	pl:setVariable("BumpFallType", "Bash");
end

function TankZedModII.attackOutput(pl)
	if TankZedModII.BashRoll(pl) then
		TankZedModII.doDrop(pl)
		TankZedModII.doFrac(pl)
		if isClient() then
			sendClientCommand('TankZedII', 'Bashed', {targID = pl:getOnlineID();})
		end
		TankZedModII.doBash(pl)
	else
		pl:setHitReaction("HitReaction")
	end
	if TankZedModII.doRoll(50) then
		TankZedModII.doAddDmg(pl)
	else
		TankZedModII.doPain(pl)
	end
end


function TankZedModII.hit(zed, pl, wpn, HP)
	if not zed then return end
	if not instanceof(zed, 'IsoZombie') then return end
	if TankZedModII.isTankZed(zed) and pl == getPlayer() then
		if zed:isCriticalHit() then
			if SandboxVars.TankZedModII.CanKill == true and TankZedModII.doRoll(25) then
				pl:Kill(zed)
				return
			end
			TankZedModII.doAddDmg(pl)
			TankZedModII.doPain(pl)
		end
		TankZedModII.attackOutput(pl)
	end
end
Events.OnWeaponHitCharacter.Remove(TankZedModII.hit)
Events.OnWeaponHitCharacter.Add(TankZedModII.hit)


-----------------------            ---------------------------
function TankZedModII.adminHitZed(zed, pl, bodyPartType, wpn)

	if TankZedModII.isWearingTankZedII(pl) then
		zed:setKnockedDown(true)
		if isClient() then
			sendClientCommand('TankZedII', 'knockDownZed', {zedID = zed:getOnlineID()})
			getSoundManager():PlayWorldSound('FallLight', zed:getSquare(), 0, 5, 5, false);
		end
	else
		zed:setKnockedDown(false)
	end


end
Events.OnHitZombie.Remove(TankZedModII.adminHitZed)
Events.OnHitZombie.Add(TankZedModII.adminHitZed)

	--zed:setVariable("ZombieHitReaction", "TankZedII_Death")

function TankZedModII.zedCollide(TankZedII, targ)
	if (TankZedModII.isTankZed(TankZedII) and instanceof(TankZedII, "IsoZombie")) or (TankZedModII.isWearingTankZedII(TankZedII) and instanceof(TankZedII, "IsoPlayer")) then

		if instanceof(targ, "IsoPlayer") then

			if isClient() then
				sendClientCommand('TankZedII', 'Bashed', {targID = targ:getOnlineID();})
			end
			TankZedModII.doBash(targ)
			return
		end
		local zed = targ
		if instanceof(zed, "IsoZombie") then

			if SandboxVars.TankZedModII.ZedKnock == false then return end
			if zed:isOnFloor() or zed:isKnockedDown() then return end
			if TankZedModII.isTankZed(zed) then return end

			--if not TankZedII:isMoving() then return end
			--if TankZedII:getTarget() == nil then return end

			if isClient() then
				sendClientCommand('TankZedII', 'knockDownZed', {zedID = zed:getOnlineID()})
			end
			zed:setKnockedDown(true)


		end

	end
end
Events.OnCharacterCollide.Remove(TankZedModII.zedCollide)
Events.OnCharacterCollide.Add(TankZedModII.zedCollide)



